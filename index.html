<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ausentismo SST</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: #f4f6f9;
}

header {
    background-color: #163a63;
    color: white;
    padding: 25px;
    text-align: center;
}

.container {
    padding: 20px;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

select {
    padding: 8px;
    font-size: 14px;
}
</style>
</head>

<body>

<header>
<h1>Dashboard Ausentismo 2025</h1>
<p>Análisis automático desde Google Sheets</p>
</header>

<div class="container">

<div class="card">
<h3>Seleccionar Enfermedad</h3>
<select id="enfermedadSelect"></select>
<p id="porcentajeEnfermedad"></p>
</div>

<div class="card">
<h3>Distribución por Origen</h3>
<canvas id="origenChart"></canvas>
</div>

<div class="card">
<h3>Días Perdidos por Enfermedad</h3>
<canvas id="enfermedadChart"></canvas>
</div>

</div>

<script>

async function cargarDatos() {

    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSH0v565bjWRWmTAAeR0XtaeQCw0BSVdmK_lAKlJz70SxXq44COlx5vIRlCcvXwXg/pub?gid=1737014280&single=true&output=csv";

    const response = await fetch(url);
    const texto = await response.text();

    const filas = texto.trim().split("\n").slice(1);

    let enfermedades = {};
    let origenes = {};
    let totalCasos = filas.length;

    filas.forEach(fila => {
        const columnas = fila.split(",");

        const enfermedad = columnas[6];
        const dias = parseFloat(columnas[7]) || 0;
        const origen = columnas[10];

        // Agrupar enfermedades
        if (!enfermedades[enfermedad]) {
            enfermedades[enfermedad] = { casos: 0, dias: 0 };
        }
        enfermedades[enfermedad].casos++;
        enfermedades[enfermedad].dias += dias;

        // Agrupar origen
        if (!origenes[origen]) {
            origenes[origen] = 0;
        }
        origenes[origen]++;
    });

    // Dropdown
    const select = document.getElementById("enfermedadSelect");
    for (let enf in enfermedades) {
        let option = document.createElement("option");
        option.value = enf;
        option.text = enf;
        select.appendChild(option);
    }

    select.addEventListener("change", function() {
        const seleccion = this.value;
        const porcentaje = (enfermedades[seleccion].casos / totalCasos) * 100;
        document.getElementById("porcentajeEnfermedad").innerText =
            "Representa el " + porcentaje.toFixed(1) + "% del total de casos.";
    });

    // Gráfico Origen
    new Chart(document.getElementById("origenChart"), {
        type: "pie",
        data: {
            labels: Object.keys(origenes),
            datasets: [{
                data: Object.values(origenes)
            }]
        }
    });

    // Gráfico Enfermedad
    new Chart(document.getElementById("enfermedadChart"), {
        type: "bar",
        data: {
            labels: Object.keys(enfermedades),
            datasets: [{
                label: "Días Perdidos",
                data: Object.values(enfermedades).map(e => e.dias)
            }]
        }
    });

}

cargarDatos();

</script>

</body>
</html>
