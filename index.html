<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ausentismo SST</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: #f4f6f9;
}

header {
    background-color: #163a63;
    color: white;
    padding: 25px;
    text-align: center;
}

.container {
    padding: 20px;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

select {
    margin: 5px;
    padding: 6px;
}
</style>
</head>

<body>

<header>
<h1>Dashboard Interactivo Ausentismo 2025</h1>
</header>

<div class="container">

<div class="card">
<h3>Filtros</h3>
<select id="nombreSelect"><option value="Todos">Todos los empleados</option></select>
<select id="codigoSelect"><option value="Todos">Todos los códigos</option></select>
<select id="enfermedadSelect"><option value="Todos">Todas las enfermedades</option></select>
<select id="origenSelect"><option value="Todos">Todos los orígenes</option></select>
</div>

<div class="card">
<h3>Días de Incapacidad por Mes</h3>
<canvas id="mesChart"></canvas>
</div>

</div>

<script>

let datosGlobales = [];
let chart;

async function cargarDatos() {

    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSH0v565bjWRWmTAAeR0XtaeQCw0BSVdmK_lAKlJz70SxXq44COlx5vIRlCcvXwXg/pub?gid=1737014280&single=true&output=csv";

    const response = await fetch(url);
    const texto = await response.text();

    const filas = texto.trim().split("\n").slice(1);

    filas.forEach(fila => {
        const c = fila.split(",");
        datosGlobales.push({
            mes: c[1],
            nombre: c[3],
            codigo: c[5],
            enfermedad: c[6],
            dias: parseFloat(c[7]) || 0,
            origen: c[10]
        });
    });

    llenarDropdowns();
    actualizarGrafica();
}

function llenarDropdowns() {

    const nombres = [...new Set(datosGlobales.map(d => d.nombre))];
    const codigos = [...new Set(datosGlobales.map(d => d.codigo))];
    const enfermedades = [...new Set(datosGlobales.map(d => d.enfermedad))];
    const origenes = [...new Set(datosGlobales.map(d => d.origen))];

    const selects = [
        { id: "nombreSelect", valores: nombres },
        { id: "codigoSelect", valores: codigos },
        { id: "enfermedadSelect", valores: enfermedades },
        { id: "origenSelect", valores: origenes }
    ];

    selects.forEach(s => {
        const select = document.getElementById(s.id);
        s.valores.forEach(v => {
            let option = document.createElement("option");
            option.value = v;
            option.text = v;
            select.appendChild(option);
        });
        select.addEventListener("change", actualizarGrafica);
    });
}

function actualizarGrafica() {

    const nombreFiltro = document.getElementById("nombreSelect").value;
    const codigoFiltro = document.getElementById("codigoSelect").value;
    const enfermedadFiltro = document.getElementById("enfermedadSelect").value;
    const origenFiltro = document.getElementById("origenSelect").value;

    let datosFiltrados = datosGlobales.filter(d =>
        (nombreFiltro === "Todos" || d.nombre === nombreFiltro) &&
        (codigoFiltro === "Todos" || d.codigo === codigoFiltro) &&
        (enfermedadFiltro === "Todos" || d.enfermedad === enfermedadFiltro) &&
        (origenFiltro === "Todos" || d.origen === origenFiltro)
    );

    let meses = {};
    datosFiltrados.forEach(d => {
        if (!meses[d.mes]) meses[d.mes] = 0;
        meses[d.mes] += d.dias;
    });

    const labels = Object.keys(meses);
    const data = Object.values(meses);

    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("mesChart"), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Días de Incapacidad",
                data: data
            }]
        }
    });
}

cargarDatos();

</script>

</body>
</html>
