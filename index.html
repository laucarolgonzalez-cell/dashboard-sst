<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ausentismo SST</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; margin:0; background:#f4f6f9; }
header { background:#163a63; color:white; padding:25px; text-align:center; }
.container { padding:20px; }
.card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; }
select { margin:5px; padding:6px; }
</style>
</head>

<body>

<header>
<h1>Dashboard Varietale Ausentismo 2025</h1>
</header>

<div class="container">

<div class="card">
<h3>Filtros</h3>
<select id="mesSelect"></select>
<select id="nombreSelect"></select>
<select id="codigoSelect"></select>
<select id="enfermedadSelect"></select>
<select id="origenSelect"></select>
</div>

<div class="card">
<h3>Días de Incapacidad por Mes</h3>
<canvas id="chart"></canvas>
</div>

</div>

<script>

let datos = [];
let chart;

const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSH0v565bjWRWmTAAeR0XtaeQCw0BSVdmK_lAKlJz70SxXq44COlx5vIRlCcvXwXg/pub?gid=1737014280&single=true&output=csv";

async function cargarDatos() {

    const response = await fetch(url);
    const texto = await response.text();
    const filas = texto.trim().split("\n").slice(1);

    filas.forEach(fila => {
        const c = fila.split(",");
        datos.push({
            mes: c[1],
            nombre: c[3],
            codigo: c[5],
            enfermedad: c[6],
            dias: parseFloat(c[7]) || 0,
            origen: c[10]
        });
    });

    actualizarTodo();
}

function actualizarTodo() {
    actualizarDropdowns();
    actualizarGrafica();
}

function actualizarDropdowns() {

    const filtros = obtenerFiltros();

    const filtrados = aplicarFiltros(filtros);

    llenarSelect("mesSelect", obtenerUnicos(filtrados, "mes"));
    llenarSelect("nombreSelect", obtenerUnicos(filtrados, "nombre"));
    llenarSelect("codigoSelect", obtenerUnicos(filtrados, "codigo"));
    llenarSelect("enfermedadSelect", obtenerUnicos(filtrados, "enfermedad"));
    llenarSelect("origenSelect", obtenerUnicos(filtrados, "origen"));
}

function obtenerFiltros() {
    return {
        mes: document.getElementById("mesSelect").value || "Todos",
        nombre: document.getElementById("nombreSelect").value || "Todos",
        codigo: document.getElementById("codigoSelect").value || "Todos",
        enfermedad: document.getElementById("enfermedadSelect").value || "Todos",
        origen: document.getElementById("origenSelect").value || "Todos"
    };
}

function aplicarFiltros(filtros) {
    return datos.filter(d =>
        (filtros.mes === "Todos" || d.mes === filtros.mes) &&
        (filtros.nombre === "Todos" || d.nombre === filtros.nombre) &&
        (filtros.codigo === "Todos" || d.codigo === filtros.codigo) &&
        (filtros.enfermedad === "Todos" || d.enfermedad === filtros.enfermedad) &&
        (filtros.origen === "Todos" || d.origen === filtros.origen)
    );
}

function obtenerUnicos(array, campo) {
    return [...new Set(array.map(d => d[campo]))];
}

function llenarSelect(id, valores) {
    const select = document.getElementById(id);
    const valorActual = select.value;

    select.innerHTML = '<option value="Todos">Todos</option>';

    valores.forEach(v => {
        let option = document.createElement("option");
        option.value = v;
        option.text = v;
        select.appendChild(option);
    });

    if (valores.includes(valorActual)) {
        select.value = valorActual;
    }

    select.onchange = actualizarTodo;
}

function actualizarGrafica() {

    const filtros = obtenerFiltros();
    const filtrados = aplicarFiltros(filtros);

    let agrupado = {};

    filtrados.forEach(d => {
        if (!agrupado[d.mes]) agrupado[d.mes] = 0;
        agrupado[d.mes] += d.dias;
    });

    const labels = Object.keys(agrupado);
    const valores = Object.values(agrupado);

    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("chart"), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Días Incapacidad",
                data: valores
            }]
        }
    });
}

cargarDatos();

</script>

</body>
</html>

