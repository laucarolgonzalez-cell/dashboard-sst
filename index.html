<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ausentismo SST</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; margin:0; background:#f4f6f9; }
header { background:#163a63; color:white; padding:25px; text-align:center; }
.container { padding:20px; }
.card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; }
select { margin:5px; padding:6px; }
</style>
</head>

<body>

<header>
<h1>Dashboard Interactivo Ausentismo 2025</h1>
</header>

<div class="container">

<div class="card">
<h3>Filtros</h3>
<select id="mesSelect"><option value="Todos">Todos los meses</option></select>
<select id="nombreSelect"><option value="Todos">Todos los empleados</option></select>
<select id="codigoSelect"><option value="Todos">Todos los códigos</option></select>
<select id="enfermedadSelect"><option value="Todos">Todas las enfermedades</option></select>
<select id="origenSelect"><option value="Todos">Todos los orígenes</option></select>
</div>

<div class="card">
<h3>Días de Incapacidad</h3>
<canvas id="chart"></canvas>
</div>

</div>

<script>

let datos = [];
let chart;

async function cargarDatos() {

    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSH0v565bjWRWmTAAeR0XtaeQCw0BSVdmK_lAKlJz70SxXq44COlx5vIRlCcvXwXg/pub?gid=1737014280&single=true&output=csv";

    const response = await fetch(url);
    const texto = await response.text();
    const filas = texto.trim().split("\n").slice(1);

    filas.forEach(fila => {
        const c = fila.split(",");

        datos.push({
            mes: c[1],
            nombre: c[3],
            codigo: c[5],
            enfermedad: c[6],
            dias: parseFloat(c[7]) || 0,
            origen: c[10]
        });
    });

    llenarDropdown("mesSelect", [...new Set(datos.map(d => d.mes))]);
    llenarDropdown("nombreSelect", [...new Set(datos.map(d => d.nombre))]);
    llenarDropdown("codigoSelect", [...new Set(datos.map(d => d.codigo))]);
    llenarDropdown("enfermedadSelect", [...new Set(datos.map(d => d.enfermedad))]);
    llenarDropdown("origenSelect", [...new Set(datos.map(d => d.origen))]);

    actualizarGrafica();
}

function llenarDropdown(id, valores) {
    const select = document.getElementById(id);
    valores.forEach(v => {
        let option = document.createElement("option");
        option.value = v;
        option.text = v;
        select.appendChild(option);
    });
    select.addEventListener("change", actualizarGrafica);
}

function actualizarGrafica() {

    const filtros = {
        mes: document.getElementById("mesSelect").value,
        nombre: document.getElementById("nombreSelect").value,
        codigo: document.getElementById("codigoSelect").value,
        enfermedad: document.getElementById("enfermedadSelect").value,
        origen: document.getElementById("origenSelect").value
    };

    let filtrados = datos.filter(d =>
        (filtros.mes === "Todos" || d.mes === filtros.mes) &&
        (filtros.nombre === "Todos" || d.nombre === filtros.nombre) &&
        (filtros.codigo === "Todos" || d.codigo === filtros.codigo) &&
        (filtros.enfermedad === "Todos" || d.enfermedad === filtros.enfermedad) &&
        (filtros.origen === "Todos" || d.origen === filtros.origen)
    );

    // Si no se filtra mes → mostrar por mes
    let agrupado = {};

    filtrados.forEach(d => {
        if (!agrupado[d.mes]) agrupado[d.mes] = 0;
        agrupado[d.mes] += d.dias;
    });

    const labels = Object.keys(agrupado);
    const valores = Object.values(agrupado);

    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("chart"), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Días Incapacidad",
                data: valores
            }]
        }
    });
}

cargarDatos();

</script>

</body>
</html>
